<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>CodeX</title>
    <link rel="icon" type="image/png" href="TemplateData/favicon.png">
    <link rel="shortcut icon" type="image/png" href="TemplateData/favicon.png">
    <link rel="stylesheet" href="TemplateData/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script src="google-auth-fix.js"></script>
    <style>
        /* Prevent page scrolling */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="unity-container" class="unity-desktop">
        <canvas id="unity-canvas" width=1920 height=1080></canvas>
        <div id="unity-loading-bar">
 <div id="unity-logo"></div>
    <div id="unity-progress-bar-empty">
      <div id="unity-progress-bar-full"></div>
            </div>
    </div>
     <div id="unity-warning"> </div>
     <div id="unity-footer">
            <div id="unity-webgl-logo"></div>
 <div id="unity-fullscreen-button"></div>
      <div id="unity-build-title">Codex (In Progress) 1</div>
        </div>
    </div>
  
    <script>
  var supabaseClient = null;
        var unityInstance = null;
        var supabaseReady = false;
  
        const SUPABASE_URL = 'https://bpjyqsfggliwehnqcbhy.supabase.co';
   const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwanlxc2ZnZ2xpd2VobnFjYmh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3OTQ4MjksImV4cCI6MjA3MDM3MDgyOX0.0Kfae4pN-paqxcRAycmQIhuAHrGZe2gs6xTKoAy7-5c';
        
  function initSupabase() {
     
 if (supabaseReady && supabaseClient !== null) {
return true;
}
  
 if (typeof supabase === 'undefined') {
       return false;
   }
   
      if (supabaseClient === null) {
 try {
   supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          window.supabase = supabaseClient;
    supabaseReady = true;
         setupAuthListener();
          
 return true;
      } catch (error) {
  return false;
   }
            }
       return true;
      }
    async function setupAuthListener() {
        
        window.supabase.auth.onAuthStateChange(async (event, session) => {
   
         if (event === 'SIGNED_IN' && session) {
     const authResponse = {
            user: {
         id: session.user.id,
   email: session.user.email
      },
session: {
     access_token: session.access_token,
      refresh_token: session.refresh_token
 }
      };
  
             if (session.user.app_metadata.provider === 'google') {
     try {
         
         const queryPromise = window.supabase
       .from('player_data')
   .select('*')
      .eq('user_id', session.user.id)
   .single();
   
         const timeoutPromise = new Promise((resolve) => 
             setTimeout(() => resolve({ data: null, error: { message: 'Query timeout' } }), 5000)
         );
         
         const { data: playerData, error: playerError } = await Promise.race([queryPromise, timeoutPromise]);
       
if (playerError && playerError.message === 'Query timeout') {
           await waitForUnityInstance();
           SendMessageToUnity('AuthManager', 'OnGoogleSignInSuccess', JSON.stringify(authResponse));
           return;
       } else if (playerError && playerError.code === 'PGRST116') {
  const username = session.user.email.split('@')[0];
       
           const { data: newPlayerData, error: createError } = await window.supabase
   .from('player_data')
    .insert({
user_id: session.user.id,
 email: session.user.email,
      username: username,
  levels_unlocked: 6,
   current_money: 0,
unlocked_cosmetics: '[]'
   })
  .select()
              .single();
    
 if (!createError && newPlayerData) {
 await waitForUnityInstance();
   SendMessageToUnity('PlayerDataManager', 'OnPlayerDataCreated', JSON.stringify(newPlayerData));
 }
       } else if (!playerError && playerData) {
            await waitForUnityInstance();
         SendMessageToUnity('PlayerDataManager', 'OnPlayerDataLoaded', JSON.stringify(playerData));
    }
   } catch (playerLoadError) {
         }
          
     await waitForUnityInstance();
    SendMessageToUnity('AuthManager', 'OnGoogleSignInSuccess', JSON.stringify(authResponse));
           } else {
      await waitForUnityInstance();
  SendMessageToUnity('AuthManager', 'OnLoginSuccess', JSON.stringify(authResponse));
        }
        }
 });
    }
 async function waitForUnityInstance() {
const maxWait = 100; // 10 seconds max
   let attempts = 0;
            
            while (!unityInstance && attempts < maxWait) {
          await new Promise(resolve => setTimeout(resolve, 100));
    attempts++;
            }
 
            if (unityInstance) {
        return true;
            } else {
          return false;
    }
     }
        let initAttempts = 0;
        const maxInitAttempts = 50;
    
        function waitForSupabase() {
            if (initSupabase()) {
         notifyUnityWhenReady();
      return;
  }
       
            initAttempts++;
    
       if (initAttempts < maxInitAttempts) {
          setTimeout(waitForSupabase, 100);
      }
        }
        
      function notifyUnityWhenReady() {
     if (unityInstance) {
     SendMessageToUnity('SupabaseReadyManager', 'OnSupabaseReady', '');
          } else {
           setTimeout(notifyUnityWhenReady, 100);
 }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', waitForSupabase);
    } else {
   waitForSupabase();
  }
        
        // Helper function to send messages to Unity
   function SendMessageToUnity(objectName, methodName, message) {
          if (unityInstance) {
    unityInstance.SendMessage(objectName, methodName, message || '');
         }
 }
        window.SetLocalStorage = function(key, value) {
       try {
         localStorage.setItem(key, value);
            } catch (error) {}
        };
        
        window.GetLocalStorage = function(key) {
        try {
    const value = localStorage.getItem(key) || '';
 return value;
    } catch (error) {
                return '';
  }
 };
   
        window.SupabaseRegister = async function(email, password) {
          if (!supabaseReady || !initSupabase()) {
    SendMessageToUnity('AuthManager', 'OnRegisterError', 'Supabase not initialized. Please refresh the page.');
      return;
  }
    
       try {
  const { data, error } = await supabaseClient.auth.signUp({
    email: email,
    password: password
         });
    
      if (error) throw error;
     
                if (data.user) {
  const username = localStorage.getItem('pendingUsername') || 'Player';
     
try {
       const { data: playerData, error: createError } = await supabaseClient
     .from('player_data')
   .insert({
                    user_id: data.user.id,
              email: email,
       username: username,
   levels_unlocked: 6,
        current_money: 0,
           unlocked_cosmetics: '[]'
  })
         .select()
       .single();
           
        if (!createError && playerData) {
         SendMessageToUnity('PlayerDataManager', 'OnPlayerDataCreated', JSON.stringify(playerData));
        }
        
 localStorage.removeItem('pendingUsername');
 } catch (createError) {
      }
    }
        
          SendMessageToUnity('AuthManager', 'OnRegisterSuccess', JSON.stringify(data));
            } catch (error) {
SendMessageToUnity('AuthManager', 'OnRegisterError', error.message);
     }
  };
        
 window.SupabaseLogin = async function(email, password) {
     if (!supabaseReady || !initSupabase()) {
            SendMessageToUnity('AuthManager', 'OnLoginError', 'Supabase not initialized. Please refresh the page.');
        return;
        }
            
            try {
    const { data, error } = await supabaseClient.auth.signInWithPassword({
         email: email,
        password: password
       });
           
          if (error) throw error;
      
      if (data.user) {
     try {
const { data: playerData, error: playerError } = await supabaseClient
      .from('player_data')
   .select('*')
           .eq('user_id', data.user.id)
          .single();
          
   if (playerError && playerError.code === 'PGRST116') {
   const username = email.split('@')[0];
      
         const { data: newPlayerData, error: createError } = await supabaseClient
 .from('player_data')
    .insert({
        user_id: data.user.id,
            email: email,
      username: username,
       levels_unlocked: 6,
    current_money: 0,
      unlocked_cosmetics: '[]'
        })
           .select()
 .single();
   
             if (!createError && newPlayerData) {
     SendMessageToUnity('PlayerDataManager', 'OnPlayerDataCreated', JSON.stringify(newPlayerData));
           }
    } else if (!playerError && playerData) {
          SendMessageToUnity('PlayerDataManager', 'OnPlayerDataLoaded', JSON.stringify(playerData));
      }
         } catch (playerLoadError) {
    }
  }
           
             SendMessageToUnity('AuthManager', 'OnLoginSuccess', JSON.stringify(data));
         } catch (error) {
 SendMessageToUnity('AuthManager', 'OnLoginError', error.message);
    }
        };
        
    window.SupabaseLogout = async function() {
  if (!supabaseReady || !initSupabase()) {
         SendMessageToUnity('AuthManager', 'OnLogoutError', 'Supabase not initialized');
     return;
      }
     
            try {
    const { error } = await supabaseClient.auth.signOut();
   if (error) throw error;
       storedSaveData = null;
    saveDataTimestamp = 0;
  try {
       localStorage.removeItem('sb-bpjyqsfggliwehnqcbhy-auth-token');
          localStorage.removeItem('pendingUsername');
   localStorage.removeItem('pendingEmail');
        } catch (storageError) {}
        try {
        sessionStorage.clear();
  } catch (sessionError) {}
    SendMessageToUnity('AuthManager', 'OnLogoutSuccess', '');
         } catch (error) {
        SendMessageToUnity('AuthManager', 'OnLogoutError', error.message);
         }
 };
   window.createPlayerData = async function(userId, email, username) {
      if (!initSupabase()) {
           SendMessageToUnity('PlayerDataManager', 'OnPlayerDataError', 'Supabase not initialized');
      return;
   }
            
          try {
          const { data, error } = await supabaseClient
            .from('player_data')
      .insert({
     user_id: userId,
        email: email,
      username: username,
         levels_unlocked: 6,
       current_money: 0,
   unlocked_cosmetics: '[]'
         })
       .select()
             .single();
      
    if (error) throw error;
     
        SendMessageToUnity('PlayerDataManager', 'OnPlayerDataCreated', JSON.stringify(data));
  } catch (error) {
    SendMessageToUnity('PlayerDataManager', 'OnPlayerDataError', error.message);
  }
        };
        
        window.loadPlayerData = async function(userId) {
  if (!initSupabase()) {
 SendMessageToUnity('PlayerDataManager', 'OnPlayerDataError', 'Supabase not initialized');
    return;
     }
    
   try {
    const { data, error } = await supabaseClient
        .from('player_data')
  .select('*')
               .eq('user_id', userId)
      .single();
      
    if (error) throw error;
   
           SendMessageToUnity('PlayerDataManager', 'OnPlayerDataLoaded', JSON.stringify(data));
} catch (error) {
     SendMessageToUnity('PlayerDataManager', 'OnPlayerDataError', error.message);
     }
   };
        
        window.updatePlayerData = async function(userId, levelsUnlocked, currentMoney, unlockedCosmetics) {
          if (!initSupabase()) {
           SendMessageToUnity('PlayerDataManager', 'OnPlayerDataError', 'Supabase not initialized');
        return;
     }
     
 try {
     const { data, error } = await supabaseClient
          .from('player_data')
          .update({
         levels_unlocked: parseInt(levelsUnlocked),
         current_money: parseInt(currentMoney),
    unlocked_cosmetics: unlockedCosmetics,
   updated_at: new Date().toISOString()
        })
        .eq('user_id', userId)
             .select()
      .single();
      
             if (error) throw error;
      
     SendMessageToUnity('PlayerDataManager', 'OnPlayerDataUpdated', JSON.stringify(data));
     } catch (error) {
       SendMessageToUnity('PlayerDataManager', 'OnPlayerDataError', error.message);
      }
     };
      
        window.getCurrentUser = async function() {
     if (!initSupabase()) {
   SendMessageToUnity('AuthManager', 'OnGetUserError', 'Supabase not initialized');
     return;
            }
            
            try {
          const { data: { user } } = await supabaseClient.auth.getUser();
                
          if (user) {
     SendMessageToUnity('AuthManager', 'OnGetUserSuccess', JSON.stringify(user));
         } else {
 SendMessageToUnity('AuthManager', 'OnGetUserError', 'No user logged in');
     }
            } catch (error) {
     SendMessageToUnity('AuthManager', 'OnGetUserError', error.message);
      }
        };
let storedSaveData = null;
        let saveDataTimestamp = 0;
window.HasPendingSaveData = function() {
            return storedSaveData !== null;
     };
        window.GetPendingSaveData = function() {
            if (storedSaveData !== null) {
            const data = storedSaveData;
        storedSaveData = null;
            saveDataTimestamp = 0;
                return data;
            } else {
return '[]';
            }
};
        
     window.LoadAllSaveSlotsJS = async function() {
    if (!initSupabase()) {
 storedSaveData = '[]';
                return;
      }
    try {
   const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
            if (userError) {
                 throw userError;
      }
      
         if (!user) {
         storedSaveData = '[]';
    saveDataTimestamp = Date.now();
         return;
   }
   
     const { data, error } = await supabaseClient
 .from('game_saves')
        .select('*')
   .eq('user_id', user.id)
   .order('slot_number', { ascending: true });
      
if (error) {
          throw error;
  }
                const jsonData = JSON.stringify(data || []);
  storedSaveData = jsonData;
     saveDataTimestamp = Date.now();
  
       } catch (error) {
        storedSaveData = '[]';
             saveDataTimestamp = Date.now();
  }
        };
        
        window.SaveSlotToSupabaseJS = async function(slotNumber, username, levelsUnlocked, currentMoney, unlockedCosmetics) {
         if (!initSupabase()) {
         return;
    }
     
          try {
          const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                if (userError) {
    throw userError;
  }
     
           if (!user) {
              return;
         }
      
    const saveData = {
     user_id: user.id,
       slot_number: slotNumber,
        username: username,
        levels_unlocked: levelsUnlocked,
        current_money: currentMoney,
   unlocked_cosmetics: unlockedCosmetics,
              last_played: new Date().toISOString(),
      updated_at: new Date().toISOString()
                };
         
        const { data, error } = await supabaseClient
         .from('game_saves')
         .upsert(saveData, {
 onConflict: 'user_id,slot_number'
 })
   .select()
          .single();
      
                if (error) {
        throw error;
          }
       SendMessageToUnity('NewAndLoadGameManager', 'OnSaveSlotSaved', JSON.stringify(saveData));
      
   } catch (error) {
         SendMessageToUnity('NewAndLoadGameManager', 'OnSaveSlotError', error.message);
 }
        };
    
     window.DeleteSlotFromSupabaseJS = async function(slotNumber) {
            if (!initSupabase()) {
       return;
        }
          
   try {
            const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
         if (userError) {
     throw userError;
    }
   
       if (!user) {
     return;
            }
      
              const { error } = await supabaseClient
           .from('game_saves')
   .delete()
     .eq('user_id', user.id)
       .eq('slot_number', slotNumber);
   
      if (error) {
         throw error;
 }
          SendMessageToUnity('NewAndLoadGameManager', 'OnSaveSlotDeleted', slotNumber.toString());
          
    } catch (error) {
           SendMessageToUnity('NewAndLoadGameManager', 'OnSaveSlotError', error.message);
          }
 };
        var container = document.querySelector("#unity-container");
    var canvas = document.querySelector("#unity-canvas");
  var loadingBar = document.querySelector("#unity-loading-bar");
        var progressBarFull = document.querySelector("#unity-progress-bar-full");
        var fullscreenButton = document.querySelector("#unity-fullscreen-button");
        var warningBanner = document.querySelector("#unity-warning");
     
      function unityShowBanner(msg, type) {
            function updateBannerVisibility() {
                warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
   }
            var div = document.createElement('div');
  div.innerHTML = msg;
            warningBanner.appendChild(div);
            if (type == 'error') div.style = 'background: red; padding: 10px;';
            else {
            if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
       setTimeout(function() {
             warningBanner.removeChild(div);
  updateBannerVisibility();
         }, 5000);
            }
       updateBannerVisibility();
        }
        
        var buildUrl = "Build";
    var loaderUrl = buildUrl + "/BuildWebGL.loader.js";
        var config = {
      dataUrl: buildUrl + "/BuildWebGL.data",
       frameworkUrl: buildUrl + "/BuildWebGL.framework.js",
            codeUrl: buildUrl + "/BuildWebGL.wasm",
     streamingAssetsUrl: "StreamingAssets",
companyName: "DefaultCompany",
    productName: "Codex (In Progress) 1",
            productVersion: "1.0",
showBanner: unityShowBanner,
        };
        
  if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
    container.className = "unity-mobile";
            config.devicePixelRatio = 1;
        } else {
            canvas.style.width = "1920px";
            canvas.style.height = "1080px";
        }
        loadingBar.style.display = "block";
     
        var script = document.createElement("script");
        script.src = loaderUrl;
        script.onload = () => {
            createUnityInstance(canvas, config, (progress) => {
       progressBarFull.style.width = 100 * progress + "%";
     }).then((instance) => {
  unityInstance = instance;
           loadingBar.style.display = "none";
         fullscreenButton.onclick = () => {
        unityInstance.SetFullscreen(1);
      };
          }).catch((message) => {
       alert(message);
      });
        };
        document.body.appendChild(script);
    </script>
</body>
</html>
